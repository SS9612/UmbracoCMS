{"version":3,"file":"index.js","sources":["../../../src/external/openid/src/base64-js/index.ts","../../../src/external/openid/src/errors.ts","../../../src/external/openid/src/crypto_utils.ts","../../../src/external/openid/src/flags.ts","../../../src/external/openid/src/logger.ts","../../../src/external/openid/src/authorization_request.ts","../../../src/external/openid/src/authorization_request_handler.ts","../../../src/external/openid/src/authorization_response.ts","../../../src/external/openid/src/xhr.ts","../../../src/external/openid/src/authorization_service_configuration.ts","../../../src/external/openid/src/query_string_utils.ts","../../../src/external/openid/src/storage.ts","../../../src/external/openid/src/redirect_based_handler.ts","../../../src/external/openid/src/revoke_token_request.ts","../../../src/external/openid/src/token_request.ts","../../../src/external/openid/src/token_response.ts","../../../src/external/openid/src/token_request_handler.ts"],"sourcesContent":["/*\r\n * This Source Code has been derived from base64-js.\r\n * https://github.com/beatgammit/base64-js\r\n * Copyright © 2014 Jameson Little\r\n * Copyright © 2024 Umbraco A/S\r\n * Licensed under the MIT License.\r\n */\r\n\r\nconst lookup: string[] = [];\r\nconst revLookup: number[] = [];\r\nconst Arr = typeof Uint8Array !== 'undefined' ? Uint8Array : Array;\r\n\r\nconst code = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';\r\nfor (var i = 0, len = code.length; i < len; ++i) {\r\n\tlookup[i] = code[i];\r\n\trevLookup[code.charCodeAt(i)] = i;\r\n}\r\n\r\n// Support decoding URL-safe base64 strings, as Node.js does.\r\n// See: https://en.wikipedia.org/wiki/Base64#URL_applications\r\nrevLookup['-'.charCodeAt(0)] = 62;\r\nrevLookup['_'.charCodeAt(0)] = 63;\r\n\r\nfunction getLens(b64: string) {\r\n\tvar len = b64.length;\r\n\r\n\tif (len % 4 > 0) {\r\n\t\tthrow new Error('Invalid string. Length must be a multiple of 4');\r\n\t}\r\n\r\n\t// Trim off extra bytes after placeholder bytes are found\r\n\t// See: https://github.com/beatgammit/base64-js/issues/42\r\n\tvar validLen = b64.indexOf('=');\r\n\tif (validLen === -1) validLen = len;\r\n\r\n\tvar placeHoldersLen = validLen === len ? 0 : 4 - (validLen % 4);\r\n\r\n\treturn [validLen, placeHoldersLen];\r\n}\r\n\r\n/**\r\n * Get the byte length of a base64 string\r\n * base64 is 4/3 + up to two characters of the original data\r\n * @param {string} b64 - The base64 string to get the byte length of\r\n * @returns {number} - The byte length\r\n */\r\nexport function byteLength(b64: string): number {\r\n\tvar lens = getLens(b64);\r\n\tvar validLen = lens[0];\r\n\tvar placeHoldersLen = lens[1];\r\n\treturn ((validLen + placeHoldersLen) * 3) / 4 - placeHoldersLen;\r\n}\r\n\r\nfunction _byteLength(b64: string, validLen: number, placeHoldersLen: number) {\r\n\treturn ((validLen + placeHoldersLen) * 3) / 4 - placeHoldersLen;\r\n}\r\n\r\n/**\r\n * Convert a base64 string to a byte array\r\n * @param {string} b64 - The base64 string to convert\r\n * @returns {Uint8Array} - The byte array\r\n */\r\nexport function toByteArray(b64: string): Uint8Array {\r\n\tvar tmp;\r\n\tvar lens = getLens(b64);\r\n\tvar validLen = lens[0];\r\n\tvar placeHoldersLen = lens[1];\r\n\r\n\tvar arr: Uint8Array = new Arr(_byteLength(b64, validLen, placeHoldersLen)) as Uint8Array;\r\n\r\n\tvar curByte = 0;\r\n\r\n\t// if there are placeholders, only get up to the last complete 4 chars\r\n\tvar len = placeHoldersLen > 0 ? validLen - 4 : validLen;\r\n\r\n\tvar i;\r\n\tfor (i = 0; i < len; i += 4) {\r\n\t\ttmp =\r\n\t\t\t(revLookup[b64.charCodeAt(i)] << 18) |\r\n\t\t\t(revLookup[b64.charCodeAt(i + 1)] << 12) |\r\n\t\t\t(revLookup[b64.charCodeAt(i + 2)] << 6) |\r\n\t\t\trevLookup[b64.charCodeAt(i + 3)];\r\n\t\tarr[curByte++] = (tmp >> 16) & 0xff;\r\n\t\tarr[curByte++] = (tmp >> 8) & 0xff;\r\n\t\tarr[curByte++] = tmp & 0xff;\r\n\t}\r\n\r\n\tif (placeHoldersLen === 2) {\r\n\t\ttmp = (revLookup[b64.charCodeAt(i)] << 2) | (revLookup[b64.charCodeAt(i + 1)] >> 4);\r\n\t\tarr[curByte++] = tmp & 0xff;\r\n\t}\r\n\r\n\tif (placeHoldersLen === 1) {\r\n\t\ttmp =\r\n\t\t\t(revLookup[b64.charCodeAt(i)] << 10) |\r\n\t\t\t(revLookup[b64.charCodeAt(i + 1)] << 4) |\r\n\t\t\t(revLookup[b64.charCodeAt(i + 2)] >> 2);\r\n\t\tarr[curByte++] = (tmp >> 8) & 0xff;\r\n\t\tarr[curByte++] = tmp & 0xff;\r\n\t}\r\n\r\n\treturn arr;\r\n}\r\n\r\nfunction tripletToBase64(num: number) {\r\n\treturn lookup[(num >> 18) & 0x3f] + lookup[(num >> 12) & 0x3f] + lookup[(num >> 6) & 0x3f] + lookup[num & 0x3f];\r\n}\r\n\r\nfunction encodeChunk(uint8: Uint8Array, start: number, end: number) {\r\n\tvar tmp;\r\n\tvar output = [];\r\n\tfor (var i = start; i < end; i += 3) {\r\n\t\ttmp = ((uint8[i] << 16) & 0xff0000) + ((uint8[i + 1] << 8) & 0xff00) + (uint8[i + 2] & 0xff);\r\n\t\toutput.push(tripletToBase64(tmp));\r\n\t}\r\n\treturn output.join('');\r\n}\r\n\r\n/**\r\n * Convert a byte array to a base64 string\r\n * @param {Uint8Array} uint8 - The byte array to convert\r\n * @returns {string} - The base64 string\r\n */\r\nexport function fromByteArray(uint8: Uint8Array): string {\r\n\tvar tmp;\r\n\tvar len = uint8.length;\r\n\tvar extraBytes = len % 3; // if we have 1 byte left, pad 2 bytes\r\n\tvar parts = [];\r\n\tvar maxChunkLength = 16383; // must be multiple of 3\r\n\r\n\t// go through the array every three bytes, we'll deal with trailing stuff later\r\n\tfor (var i = 0, len2 = len - extraBytes; i < len2; i += maxChunkLength) {\r\n\t\tparts.push(encodeChunk(uint8, i, i + maxChunkLength > len2 ? len2 : i + maxChunkLength));\r\n\t}\r\n\r\n\t// pad the end with zeros, but make sure to not forget the extra bytes\r\n\tif (extraBytes === 1) {\r\n\t\ttmp = uint8[len - 1];\r\n\t\tparts.push(lookup[tmp >> 2] + lookup[(tmp << 4) & 0x3f] + '==');\r\n\t} else if (extraBytes === 2) {\r\n\t\ttmp = (uint8[len - 2] << 8) + uint8[len - 1];\r\n\t\tparts.push(lookup[tmp >> 10] + lookup[(tmp >> 4) & 0x3f] + lookup[(tmp << 2) & 0x3f] + '=');\r\n\t}\r\n\r\n\treturn parts.join('');\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\n/**\r\n * Represents the AppAuthError type.\r\n */\r\nexport class AppAuthError {\r\n\tconstructor(\r\n\t\tpublic message: string,\r\n\t\tpublic extras?: any,\r\n\t) {}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { fromByteArray } from './base64-js/index.js';\r\nimport { AppAuthError } from './errors.js';\r\n\r\nconst HAS_CRYPTO = typeof window !== 'undefined' && !!(window.crypto as any);\r\nconst HAS_SUBTLE_CRYPTO = HAS_CRYPTO && !!(window.crypto.subtle as any);\r\nconst CHARSET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n\r\nexport function bufferToString(buffer: Uint8Array) {\r\n\tconst state = [];\r\n\tfor (let i = 0; i < buffer.byteLength; i += 1) {\r\n\t\tconst index = buffer[i] % CHARSET.length;\r\n\t\tstate.push(CHARSET[index]);\r\n\t}\r\n\treturn state.join('');\r\n}\r\n\r\nexport function urlSafe(buffer: Uint8Array): string {\r\n\tconst encoded = fromByteArray(new Uint8Array(buffer));\r\n\treturn encoded.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\r\n}\r\n\r\n// adapted from source: http://stackoverflow.com/a/11058858\r\n// this is used in place of TextEncode as the api is not yet\r\n// well supported: https://caniuse.com/#search=TextEncoder\r\nexport function textEncodeLite(str: string) {\r\n\tconst buf = new ArrayBuffer(str.length);\r\n\tconst bufView = new Uint8Array(buf);\r\n\r\n\tfor (let i = 0; i < str.length; i++) {\r\n\t\tbufView[i] = str.charCodeAt(i);\r\n\t}\r\n\treturn bufView;\r\n}\r\n\r\nexport interface Crypto {\r\n\t/**\r\n\t * Generate a random string\r\n\t */\r\n\tgenerateRandom(size: number): string;\r\n\t/**\r\n\t * Compute the SHA256 of a given code.\r\n\t * This is useful when using PKCE.\r\n\t */\r\n\tderiveChallenge(code: string): Promise<string>;\r\n}\r\n\r\n/**\r\n * The default implementation of the `Crypto` interface.\r\n * This uses the capabilities of the browser.\r\n */\r\nexport class DefaultCrypto implements Crypto {\r\n\tgenerateRandom(size: number) {\r\n\t\tconst buffer = new Uint8Array(size);\r\n\t\tif (HAS_CRYPTO) {\r\n\t\t\twindow.crypto.getRandomValues(buffer);\r\n\t\t} else {\r\n\t\t\t// fall back to Math.random() if nothing else is available\r\n\t\t\tfor (let i = 0; i < size; i += 1) {\r\n\t\t\t\tbuffer[i] = (Math.random() * CHARSET.length) | 0;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn bufferToString(buffer);\r\n\t}\r\n\r\n\tderiveChallenge(code: string): Promise<string> {\r\n\t\tif (code.length < 43 || code.length > 128) {\r\n\t\t\treturn Promise.reject(new AppAuthError('Invalid code length.'));\r\n\t\t}\r\n\t\tif (!HAS_SUBTLE_CRYPTO) {\r\n\t\t\treturn Promise.reject(new AppAuthError('window.crypto.subtle is unavailable.'));\r\n\t\t}\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tcrypto.subtle.digest('SHA-256', textEncodeLite(code)).then(\r\n\t\t\t\t(buffer) => {\r\n\t\t\t\t\treturn resolve(urlSafe(new Uint8Array(buffer)));\r\n\t\t\t\t},\r\n\t\t\t\t(error) => reject(error),\r\n\t\t\t);\r\n\t\t});\r\n\t}\r\n}\r\n","/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\n/* Global flags that control the behavior of App Auth JS. */\r\n\r\n/* Logging turned on ? */\r\nexport const IS_LOG = true;\r\n\r\n/* Profiling turned on ? */\r\nexport const IS_PROFILE = false;\r\n","/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { IS_LOG, IS_PROFILE } from './flags.js';\r\n\r\nexport function log(message: string, ...args: any[]) {\r\n\tif (IS_LOG) {\r\n\t\tconst length = args ? args.length : 0;\r\n\t\tif (length > 0) {\r\n\t\t\tconsole.log(message, ...args);\r\n\t\t} else {\r\n\t\t\tconsole.log(message);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// check to see if native support for profiling is available.\r\nconst NATIVE_PROFILE_SUPPORT = typeof window !== 'undefined' && !!window.performance && !!console.profile;\r\n\r\n/**\r\n * A decorator that can profile a function.\r\n */\r\nexport function profile(target: any, propertyKey: string, descriptor: PropertyDescriptor) {\r\n\tif (IS_PROFILE) {\r\n\t\treturn performProfile(target, propertyKey, descriptor);\r\n\t} else {\r\n\t\t// return as-is\r\n\t\treturn descriptor;\r\n\t}\r\n}\r\n\r\nfunction performProfile(target: any, propertyKey: string, descriptor: PropertyDescriptor): PropertyDescriptor {\r\n\tconst originalCallable = descriptor.value;\r\n\t// name must exist\r\n\tlet name = originalCallable.name;\r\n\tif (!name) {\r\n\t\tname = 'anonymous function';\r\n\t}\r\n\tif (NATIVE_PROFILE_SUPPORT) {\r\n\t\tdescriptor.value = function (args: any[]) {\r\n\t\t\tconsole.profile(name);\r\n\t\t\tconst startTime = window.performance.now();\r\n\t\t\tconst result = originalCallable.call(this || window, ...args);\r\n\t\t\tconst duration = window.performance.now() - startTime;\r\n\t\t\tconsole.log(`${name} took ${duration} ms`);\r\n\t\t\tconsole.profileEnd();\r\n\t\t\treturn result;\r\n\t\t};\r\n\t} else {\r\n\t\tdescriptor.value = function (args: any[]) {\r\n\t\t\tlog(`Profile start ${name}`);\r\n\t\t\tconst start = Date.now();\r\n\t\t\tconst result = originalCallable.call(this || window, ...args);\r\n\t\t\tconst duration = Date.now() - start;\r\n\t\t\tlog(`Profile end ${name} took ${duration} ms.`);\r\n\t\t\treturn result;\r\n\t\t};\r\n\t}\r\n\treturn descriptor;\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { DefaultCrypto } from './crypto_utils.js';\r\nimport type { Crypto } from './crypto_utils.js';\r\nimport { log } from './logger.js';\r\nimport type { StringMap } from './types.js';\r\n\r\n/**\r\n * Represents an AuthorizationRequest as JSON.\r\n */\r\nexport interface AuthorizationRequestJson {\r\n\tresponse_type: string;\r\n\tclient_id: string;\r\n\tredirect_uri: string;\r\n\tscope: string;\r\n\tstate?: string;\r\n\textras?: StringMap;\r\n\tinternal?: StringMap;\r\n}\r\n\r\n/**\r\n * Generates a cryptographically random new state. Useful for CSRF protection.\r\n */\r\nconst SIZE = 10; // 10 bytes\r\nconst newState = function (crypto: Crypto): string {\r\n\treturn crypto.generateRandom(SIZE);\r\n};\r\n\r\n/**\r\n * Represents the AuthorizationRequest.\r\n * For more information look at\r\n * https://tools.ietf.org/html/rfc6749#section-4.1.1\r\n */\r\nexport class AuthorizationRequest {\r\n\tstatic RESPONSE_TYPE_TOKEN = 'token';\r\n\tstatic RESPONSE_TYPE_CODE = 'code';\r\n\r\n\t// NOTE:\r\n\t// Both redirect_uri and state are actually optional.\r\n\t// However AppAuth is more opionionated, and requires you to use both.\r\n\r\n\tclientId: string;\r\n\tredirectUri: string;\r\n\tscope: string;\r\n\tresponseType: string;\r\n\tstate: string;\r\n\textras?: StringMap;\r\n\tinternal?: StringMap;\r\n\t/**\r\n\t * Constructs a new AuthorizationRequest.\r\n\t * Use a `undefined` value for the `state` parameter, to generate a random\r\n\t * state for CSRF protection.\r\n\t */\r\n\tconstructor(\r\n\t\trequest: AuthorizationRequestJson,\r\n\t\tprivate crypto: Crypto = new DefaultCrypto(),\r\n\t\tprivate usePkce: boolean = true,\r\n\t) {\r\n\t\tthis.clientId = request.client_id;\r\n\t\tthis.redirectUri = request.redirect_uri;\r\n\t\tthis.scope = request.scope;\r\n\t\tthis.responseType = request.response_type || AuthorizationRequest.RESPONSE_TYPE_CODE;\r\n\t\tthis.state = request.state || newState(crypto);\r\n\t\tthis.extras = request.extras;\r\n\t\t// read internal properties if available\r\n\t\tthis.internal = request.internal;\r\n\t}\r\n\r\n\tsetupCodeVerifier(): Promise<void> {\r\n\t\tif (!this.usePkce) {\r\n\t\t\treturn Promise.resolve();\r\n\t\t} else {\r\n\t\t\tconst codeVerifier = this.crypto.generateRandom(128);\r\n\t\t\tconst challenge: Promise<string | undefined> = this.crypto.deriveChallenge(codeVerifier).catch((error) => {\r\n\t\t\t\tlog('Unable to generate PKCE challenge. Not using PKCE', error);\r\n\t\t\t\treturn undefined;\r\n\t\t\t});\r\n\t\t\treturn challenge.then((result) => {\r\n\t\t\t\tif (result) {\r\n\t\t\t\t\t// keep track of the code used.\r\n\t\t\t\t\tthis.internal = this.internal || {};\r\n\t\t\t\t\tthis.internal['code_verifier'] = codeVerifier;\r\n\t\t\t\t\tthis.extras = this.extras || {};\r\n\t\t\t\t\tthis.extras['code_challenge'] = result;\r\n\t\t\t\t\t// We always use S256. Plain is not good enough.\r\n\t\t\t\t\tthis.extras['code_challenge_method'] = 'S256';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Serializes the AuthorizationRequest to a JavaScript Object.\r\n\t */\r\n\ttoJson(): Promise<AuthorizationRequestJson> {\r\n\t\t// Always make sure that the code verifier is setup when toJson() is called.\r\n\t\treturn this.setupCodeVerifier().then(() => {\r\n\t\t\treturn {\r\n\t\t\t\tresponse_type: this.responseType,\r\n\t\t\t\tclient_id: this.clientId,\r\n\t\t\t\tredirect_uri: this.redirectUri,\r\n\t\t\t\tscope: this.scope,\r\n\t\t\t\tstate: this.state,\r\n\t\t\t\textras: this.extras,\r\n\t\t\t\tinternal: this.internal,\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport type { AuthorizationRequest } from './authorization_request.js';\r\nimport type { AuthorizationError, AuthorizationResponse } from './authorization_response.js';\r\nimport type { AuthorizationServiceConfiguration } from './authorization_service_configuration.js';\r\nimport type { Crypto } from './crypto_utils.js';\r\nimport { log } from './logger.js';\r\nimport type { QueryStringUtils } from './query_string_utils.js';\r\nimport type { StringMap } from './types.js';\r\n\r\n/**\r\n * This type represents a lambda that can take an AuthorizationRequest,\r\n * and an AuthorizationResponse as arguments.\r\n */\r\nexport type AuthorizationListener = (\r\n\trequest: AuthorizationRequest,\r\n\tresponse: AuthorizationResponse | null,\r\n\terror: AuthorizationError | null,\r\n) => void;\r\n\r\n/**\r\n * Represents a structural type holding both authorization request and response.\r\n */\r\nexport interface AuthorizationRequestResponse {\r\n\trequest: AuthorizationRequest;\r\n\tresponse: AuthorizationResponse | null;\r\n\terror: AuthorizationError | null;\r\n}\r\n\r\n/**\r\n * Authorization Service notifier.\r\n * This manages the communication of the AuthorizationResponse to the 3p client.\r\n */\r\nexport class AuthorizationNotifier {\r\n\tprivate listener: AuthorizationListener | null = null;\r\n\r\n\tsetAuthorizationListener(listener: AuthorizationListener) {\r\n\t\tthis.listener = listener;\r\n\t}\r\n\r\n\t/**\r\n\t * The authorization complete callback.\r\n\t */\r\n\tonAuthorizationComplete(\r\n\t\trequest: AuthorizationRequest,\r\n\t\tresponse: AuthorizationResponse | null,\r\n\t\terror: AuthorizationError | null,\r\n\t): void {\r\n\t\tif (this.listener) {\r\n\t\t\t// complete authorization request\r\n\t\t\tthis.listener(request, response, error);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// TODO(rahulrav@): add more built in parameters.\r\n/* built in parameters. */\r\nexport const BUILT_IN_PARAMETERS = ['redirect_uri', 'client_id', 'response_type', 'state', 'scope'];\r\n\r\n/**\r\n * Defines the interface which is capable of handling an authorization request\r\n * using various methods (iframe / popup / different process etc.).\r\n */\r\nexport abstract class AuthorizationRequestHandler {\r\n\tconstructor(\r\n\t\tpublic utils: QueryStringUtils,\r\n\t\tprotected crypto: Crypto,\r\n\t) {}\r\n\r\n\t// notifier send the response back to the client.\r\n\tprotected notifier: AuthorizationNotifier | null = null;\r\n\r\n\t/**\r\n\t * A utility method to be able to build the authorization request URL.\r\n\t */\r\n\tprotected buildRequestUrl(configuration: AuthorizationServiceConfiguration, request: AuthorizationRequest) {\r\n\t\t// build the query string\r\n\t\t// coerce to any type for convenience\r\n\t\tconst requestMap: StringMap = {\r\n\t\t\tredirect_uri: request.redirectUri,\r\n\t\t\tclient_id: request.clientId,\r\n\t\t\tresponse_type: request.responseType,\r\n\t\t\tstate: request.state,\r\n\t\t\tscope: request.scope,\r\n\t\t};\r\n\r\n\t\t// copy over extras\r\n\t\tif (request.extras) {\r\n\t\t\tfor (const extra in request.extras) {\r\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(request.extras, extra)) {\r\n\t\t\t\t\t// check before inserting to requestMap\r\n\t\t\t\t\tif (BUILT_IN_PARAMETERS.indexOf(extra) < 0) {\r\n\t\t\t\t\t\trequestMap[extra] = request.extras[extra];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst query = this.utils.stringify(requestMap);\r\n\t\tconst baseUrl = configuration.authorizationEndpoint;\r\n\t\tconst url = `${baseUrl}?${query}`;\r\n\t\treturn url;\r\n\t}\r\n\r\n\t/**\r\n\t * Completes the authorization request if necessary & when possible.\r\n\t */\r\n\tcompleteAuthorizationRequestIfPossible(): Promise<void> {\r\n\t\t// call complete authorization if possible to see there might\r\n\t\t// be a response that needs to be delivered.\r\n\t\tlog(`Checking to see if there is an authorization response to be delivered.`);\r\n\t\tif (!this.notifier) {\r\n\t\t\tlog(`Notifier is not present on AuthorizationRequest handler.\r\n          No delivery of result will be possible`);\r\n\t\t}\r\n\t\treturn this.completeAuthorizationRequest().then((result) => {\r\n\t\t\tif (!result) {\r\n\t\t\t\tlog(`No result is available yet.`);\r\n\t\t\t}\r\n\t\t\tif (result && this.notifier) {\r\n\t\t\t\tthis.notifier.onAuthorizationComplete(result.request, result.response, result.error);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the default Authorization Service notifier.\r\n\t */\r\n\tsetAuthorizationNotifier(notifier: AuthorizationNotifier): AuthorizationRequestHandler {\r\n\t\tthis.notifier = notifier;\r\n\t\treturn this;\r\n\t}\r\n\r\n\t/**\r\n\t * Makes an authorization request.\r\n\t */\r\n\tabstract performAuthorizationRequest(\r\n\t\tconfiguration: AuthorizationServiceConfiguration,\r\n\t\trequest: AuthorizationRequest,\r\n\t): void;\r\n\r\n\t/**\r\n\t * Checks if an authorization flow can be completed, and completes it.\r\n\t * The handler returns a `Promise<AuthorizationRequestResponse>` if ready, or a `Promise<null>`\r\n\t * if not ready.\r\n\t */\r\n\tprotected abstract completeAuthorizationRequest(): Promise<AuthorizationRequestResponse | null>;\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\n/**\r\n * Represents the AuthorizationResponse as a JSON object.\r\n */\r\nexport interface AuthorizationResponseJson {\r\n\tcode: string;\r\n\tstate: string;\r\n}\r\n\r\n/**\r\n * Represents the AuthorizationError as a JSON object.\r\n */\r\nexport interface AuthorizationErrorJson {\r\n\terror: string;\r\n\terror_description?: string;\r\n\terror_uri?: string;\r\n\tstate?: string;\r\n}\r\n\r\n/**\r\n * Represents the Authorization Response type.\r\n * For more information look at\r\n * https://tools.ietf.org/html/rfc6749#section-4.1.2\r\n */\r\nexport class AuthorizationResponse {\r\n\tcode: string;\r\n\tstate: string;\r\n\r\n\tconstructor(response: AuthorizationResponseJson) {\r\n\t\tthis.code = response.code;\r\n\t\tthis.state = response.state;\r\n\t}\r\n\r\n\ttoJson(): AuthorizationResponseJson {\r\n\t\treturn { code: this.code, state: this.state };\r\n\t}\r\n}\r\n\r\n/**\r\n * Represents the Authorization error response.\r\n * For more information look at:\r\n * https://tools.ietf.org/html/rfc6749#section-4.1.2.1\r\n */\r\nexport class AuthorizationError {\r\n\terror: string;\r\n\terrorDescription?: string;\r\n\terrorUri?: string;\r\n\tstate?: string;\r\n\r\n\tconstructor(error: AuthorizationErrorJson) {\r\n\t\tthis.error = error.error;\r\n\t\tthis.errorDescription = error.error_description;\r\n\t\tthis.errorUri = error.error_uri;\r\n\t\tthis.state = error.state;\r\n\t}\r\n\r\n\ttoJson(): AuthorizationErrorJson {\r\n\t\treturn {\r\n\t\t\terror: this.error,\r\n\t\t\terror_description: this.errorDescription,\r\n\t\t\terror_uri: this.errorUri,\r\n\t\t\tstate: this.state,\r\n\t\t};\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { AppAuthError } from './errors.js';\r\nimport type { XhrRequestInit } from './types.js';\r\n\r\n/**\r\n * An class that abstracts away the ability to make an XMLHttpRequest.\r\n */\r\nexport abstract class Requestor {\r\n\tabstract xhr<T>(settings: unknown): Promise<T>;\r\n}\r\n\r\n/**\r\n * Uses fetch API to make Ajax requests\r\n */\r\nexport class FetchRequestor extends Requestor {\r\n\txhr<T>(settings: XhrRequestInit): Promise<T> {\r\n\t\tif (!settings.url) {\r\n\t\t\treturn Promise.reject(new AppAuthError('A URL must be provided.'));\r\n\t\t}\r\n\t\tconst url: URL = new URL(<string>settings.url);\r\n\t\tconst requestInit: RequestInit = {};\r\n\t\trequestInit.method = settings.method;\r\n\t\trequestInit.mode = 'cors';\r\n\r\n\t\tif (settings.data) {\r\n\t\t\tif (settings.method && settings.method.toUpperCase() === 'POST') {\r\n\t\t\t\trequestInit.body = <string>settings.data;\r\n\t\t\t} else {\r\n\t\t\t\tconst searchParams = new URLSearchParams(settings.data);\r\n\t\t\t\tsearchParams.forEach((value, key) => {\r\n\t\t\t\t\turl.searchParams.append(key, value);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Set the request headers\r\n\t\trequestInit.headers = {};\r\n\t\tif (settings.headers) {\r\n\t\t\trequestInit.headers = settings.headers;\r\n\t\t}\r\n\r\n\t\tconst isJsonDataType = settings.dataType && settings.dataType.toLowerCase() === 'json';\r\n\r\n\t\t// Set 'Accept' header value for json requests (Taken from\r\n\t\t// https://github.com/jquery/jquery/blob/e0d941156900a6bff7c098c8ea7290528e468cf8/src/ajax.js#L644\r\n\t\t// )\r\n\t\tif (isJsonDataType) {\r\n\t\t\t(requestInit.headers as any).Accept = 'application/json, text/javascript, */*; q=0.01';\r\n\t\t}\r\n\r\n\t\treturn fetch(url.toString(), requestInit).then((response) => {\r\n\t\t\tif (response.status >= 200 && response.status < 300) {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tif (isJsonDataType || (contentType && contentType.indexOf('application/json') !== -1)) {\r\n\t\t\t\t\treturn response.json();\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn response.text();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\treturn Promise.reject(new AppAuthError(response.status.toString(), response.statusText));\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport type { Requestor } from './xhr.js';\r\nimport { FetchRequestor } from './xhr.js';\r\n\r\n/**\r\n * Represents AuthorizationServiceConfiguration as a JSON object.\r\n */\r\nexport interface AuthorizationServiceConfigurationJson {\r\n\tauthorization_endpoint: string;\r\n\ttoken_endpoint: string;\r\n\trevocation_endpoint: string;\r\n\tend_session_endpoint?: string;\r\n\tuserinfo_endpoint?: string;\r\n}\r\n\r\n/**\r\n * The standard base path for well-known resources on domains.\r\n * See https://tools.ietf.org/html/rfc5785 for more information.\r\n */\r\nconst WELL_KNOWN_PATH = '.well-known';\r\n\r\n/**\r\n * The standard resource under the well known path at which an OpenID Connect\r\n * discovery document can be found under an issuer's base URI.\r\n */\r\nconst OPENID_CONFIGURATION = 'openid-configuration';\r\n\r\n/**\r\n * Configuration details required to interact with an authorization service.\r\n *\r\n * More information at https://openid.net/specs/openid-connect-discovery-1_0-17.html\r\n */\r\nexport class AuthorizationServiceConfiguration {\r\n\tauthorizationEndpoint: string;\r\n\ttokenEndpoint: string;\r\n\trevocationEndpoint: string;\r\n\tuserInfoEndpoint?: string;\r\n\tendSessionEndpoint?: string;\r\n\r\n\tconstructor(request: AuthorizationServiceConfigurationJson) {\r\n\t\tthis.authorizationEndpoint = request.authorization_endpoint;\r\n\t\tthis.tokenEndpoint = request.token_endpoint;\r\n\t\tthis.revocationEndpoint = request.revocation_endpoint;\r\n\t\tthis.userInfoEndpoint = request.userinfo_endpoint;\r\n\t\tthis.endSessionEndpoint = request.end_session_endpoint;\r\n\t}\r\n\r\n\ttoJson() {\r\n\t\treturn {\r\n\t\t\tauthorization_endpoint: this.authorizationEndpoint,\r\n\t\t\ttoken_endpoint: this.tokenEndpoint,\r\n\t\t\trevocation_endpoint: this.revocationEndpoint,\r\n\t\t\tend_session_endpoint: this.endSessionEndpoint,\r\n\t\t\tuserinfo_endpoint: this.userInfoEndpoint,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic fetchFromIssuer(openIdIssuerUrl: string, requestor?: Requestor): Promise<AuthorizationServiceConfiguration> {\r\n\t\tconst fullUrl = `${openIdIssuerUrl}/${WELL_KNOWN_PATH}/${OPENID_CONFIGURATION}`;\r\n\r\n\t\tconst requestorToUse = requestor || new FetchRequestor();\r\n\r\n\t\treturn requestorToUse\r\n\t\t\t.xhr<AuthorizationServiceConfigurationJson>({ url: fullUrl, dataType: 'json', method: 'GET' })\r\n\t\t\t.then((json) => new AuthorizationServiceConfiguration(json));\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport type { LocationLike, StringMap } from './types.js';\r\n\r\n/**\r\n * Query String Utilities.\r\n */\r\nexport interface QueryStringUtils {\r\n\tstringify(input: StringMap): string;\r\n\tparse(query: LocationLike, useHash?: boolean): StringMap;\r\n\tparseQueryString(query: string): StringMap;\r\n}\r\n\r\nexport class BasicQueryStringUtils implements QueryStringUtils {\r\n\tparse(input: LocationLike, useHash?: boolean) {\r\n\t\tif (useHash) {\r\n\t\t\treturn this.parseQueryString(input.hash);\r\n\t\t} else {\r\n\t\t\treturn this.parseQueryString(input.search);\r\n\t\t}\r\n\t}\r\n\r\n\tparseQueryString(query: string): StringMap {\r\n\t\tconst result: StringMap = {};\r\n\t\t// if anything starts with ?, # or & remove it\r\n\t\tquery = query.trim().replace(/^(\\?|#|&)/, '');\r\n\t\tconst params = query.split('&');\r\n\t\tfor (let i = 0; i < params.length; i += 1) {\r\n\t\t\tconst param = params[i]; // looks something like a=b\r\n\t\t\tconst parts = param.split('=');\r\n\t\t\tif (parts.length >= 2) {\r\n\t\t\t\tconst key = decodeURIComponent(parts.shift()!);\r\n\t\t\t\tconst value = parts.length > 0 ? parts.join('=') : null;\r\n\t\t\t\tif (value) {\r\n\t\t\t\t\tresult[key] = decodeURIComponent(value);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn result;\r\n\t}\r\n\r\n\tstringify(input: StringMap) {\r\n\t\tconst encoded: string[] = [];\r\n\t\tfor (const key in input) {\r\n\t\t\tif (Object.prototype.hasOwnProperty.call(input, key) && input[key]) {\r\n\t\t\t\tencoded.push(`${encodeURIComponent(key)}=${encodeURIComponent(input[key])}`);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn encoded.join('&');\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\n/**\r\n * A subset of the `Storage` interface which we need for the backends to work.\r\n *\r\n * Essentially removes the indexable properties and readonly properties from\r\n * `Storage` in lib.dom.d.ts. This is so that a custom type can extend it for\r\n * testing.\r\n */\r\nexport interface UnderlyingStorage {\r\n\treadonly length: number;\r\n\tclear(): void;\r\n\tgetItem(key: string): string | null;\r\n\tremoveItem(key: string): void;\r\n\tsetItem(key: string, data: string): void;\r\n}\r\n\r\n/**\r\n * Asynchronous storage APIs. All methods return a `Promise`.\r\n * All methods take the `DOMString`\r\n * IDL type (as it is the lowest common denominator).\r\n */\r\nexport abstract class StorageBackend {\r\n\t/**\r\n\t * When passed a key `name`, will return that key's value.\r\n\t */\r\n\tpublic abstract getItem(name: string): Promise<string | null>;\r\n\r\n\t/**\r\n\t * When passed a key `name`, will remove that key from the storage.\r\n\t */\r\n\tpublic abstract removeItem(name: string): Promise<void>;\r\n\r\n\t/**\r\n\t * When invoked, will empty all keys out of the storage.\r\n\t */\r\n\tpublic abstract clear(): Promise<void>;\r\n\r\n\t/**\r\n\t * The setItem() method of the `StorageBackend` interface,\r\n\t * when passed a key name and value, will add that key to the storage,\r\n\t * or update that key's value if it already exists.\r\n\t */\r\n\tpublic abstract setItem(name: string, value: string): Promise<void>;\r\n}\r\n\r\n/**\r\n * A `StorageBackend` backed by `localstorage`.\r\n */\r\nexport class LocalStorageBackend extends StorageBackend {\r\n\tprivate storage: UnderlyingStorage;\r\n\tconstructor(storage?: UnderlyingStorage) {\r\n\t\tsuper();\r\n\t\tthis.storage = storage || window.localStorage;\r\n\t}\r\n\r\n\tpublic getItem(name: string): Promise<string | null> {\r\n\t\treturn new Promise<string | null>((resolve, reject) => {\r\n\t\t\tconst value = this.storage.getItem(name);\r\n\t\t\tif (value) {\r\n\t\t\t\tresolve(value);\r\n\t\t\t} else {\r\n\t\t\t\tresolve(null);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tpublic removeItem(name: string): Promise<void> {\r\n\t\treturn new Promise<void>((resolve, reject) => {\r\n\t\t\tthis.storage.removeItem(name);\r\n\t\t\tresolve();\r\n\t\t});\r\n\t}\r\n\r\n\tpublic clear(): Promise<void> {\r\n\t\treturn new Promise<void>((resolve, reject) => {\r\n\t\t\tthis.storage.clear();\r\n\t\t\tresolve();\r\n\t\t});\r\n\t}\r\n\r\n\tpublic setItem(name: string, value: string): Promise<void> {\r\n\t\treturn new Promise<void>((resolve, reject) => {\r\n\t\t\tthis.storage.setItem(name, value);\r\n\t\t\tresolve();\r\n\t\t});\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { AuthorizationRequest } from './authorization_request.js';\r\nimport type { AuthorizationRequestResponse } from './authorization_request_handler.js';\r\nimport { AuthorizationRequestHandler } from './authorization_request_handler.js';\r\nimport { AuthorizationError, AuthorizationResponse } from './authorization_response.js';\r\nimport type { AuthorizationServiceConfiguration } from './authorization_service_configuration.js';\r\nimport type { Crypto } from './crypto_utils.js';\r\nimport { DefaultCrypto } from './crypto_utils.js';\r\nimport { log } from './logger.js';\r\nimport { BasicQueryStringUtils } from './query_string_utils.js';\r\nimport type { StorageBackend } from './storage.js';\r\nimport { LocalStorageBackend } from './storage.js';\r\nimport type { LocationLike } from './types.js';\r\n\r\n/** key for authorization request. */\r\nconst authorizationRequestKey = (handle: string) => {\r\n\treturn `${handle}_appauth_authorization_request`;\r\n};\r\n\r\n/** key for authorization service configuration */\r\nconst authorizationServiceConfigurationKey = (handle: string) => {\r\n\treturn `${handle}_appauth_authorization_service_configuration`;\r\n};\r\n\r\n/** key in local storage which represents the current authorization request. */\r\nconst AUTHORIZATION_REQUEST_HANDLE_KEY = 'appauth_current_authorization_request';\r\n\r\n/**\r\n * Represents an AuthorizationRequestHandler which uses a standard\r\n * redirect based code flow.\r\n */\r\nexport class RedirectRequestHandler extends AuthorizationRequestHandler {\r\n\tconstructor(\r\n\t\t// use the provided storage backend\r\n\t\t// or initialize local storage with the default storage backend which\r\n\t\t// uses window.localStorage\r\n\t\tpublic storageBackend: StorageBackend = new LocalStorageBackend(),\r\n\t\tutils = new BasicQueryStringUtils(),\r\n\t\tpublic locationLike: LocationLike = window.location,\r\n\t\tcrypto: Crypto = new DefaultCrypto(),\r\n\t) {\r\n\t\tsuper(utils, crypto);\r\n\t}\r\n\r\n\tperformAuthorizationRequest(configuration: AuthorizationServiceConfiguration, request: AuthorizationRequest) {\r\n\t\tconst handle = this.crypto.generateRandom(10);\r\n\r\n\t\t// before you make request, persist all request related data in local storage.\r\n\t\tconst persisted = Promise.all([\r\n\t\t\tthis.storageBackend.setItem(AUTHORIZATION_REQUEST_HANDLE_KEY, handle),\r\n\t\t\t// Calling toJson() adds in the code & challenge when possible\r\n\t\t\trequest\r\n\t\t\t\t.toJson()\r\n\t\t\t\t.then((result) => this.storageBackend.setItem(authorizationRequestKey(handle), JSON.stringify(result))),\r\n\t\t\tthis.storageBackend.setItem(authorizationServiceConfigurationKey(handle), JSON.stringify(configuration.toJson())),\r\n\t\t]);\r\n\r\n\t\treturn persisted.then(() => {\r\n\t\t\t// make the redirect request\r\n\t\t\tconst url = this.buildRequestUrl(configuration, request);\r\n\t\t\tlog('Making a request to ', request, url);\r\n\t\t\treturn url;\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Attempts to introspect the contents of storage backend and completes the\r\n\t * request.\r\n\t */\r\n\tprotected completeAuthorizationRequest(): Promise<AuthorizationRequestResponse | null> {\r\n\t\t// TODO(rahulrav@): handle authorization errors.\r\n\t\treturn this.storageBackend.getItem(AUTHORIZATION_REQUEST_HANDLE_KEY).then((handle) => {\r\n\t\t\tif (handle) {\r\n\t\t\t\t// we have a pending request.\r\n\t\t\t\t// fetch authorization request, and check state\r\n\t\t\t\treturn (\r\n\t\t\t\t\tthis.storageBackend\r\n\t\t\t\t\t\t.getItem(authorizationRequestKey(handle))\r\n\t\t\t\t\t\t// requires a corresponding instance of result\r\n\t\t\t\t\t\t// TODO(rahulrav@): check for inconsitent state here\r\n\t\t\t\t\t\t.then((result) => JSON.parse(result!))\r\n\t\t\t\t\t\t.then((json) => new AuthorizationRequest(json))\r\n\t\t\t\t\t\t.then((request) => {\r\n\t\t\t\t\t\t\t// check redirect_uri and state\r\n\t\t\t\t\t\t\tconst currentUri = `${this.locationLike.origin}${this.locationLike.pathname}`;\r\n\t\t\t\t\t\t\tconst queryParams = this.utils.parse(this.locationLike, true /* use hash */);\r\n\t\t\t\t\t\t\tconst state: string | undefined = queryParams['state'];\r\n\t\t\t\t\t\t\tconst code: string | undefined = queryParams['code'];\r\n\t\t\t\t\t\t\tconst error: string | undefined = queryParams['error'];\r\n\t\t\t\t\t\t\tlog('Potential authorization request ', currentUri, queryParams, state, code, error);\r\n\t\t\t\t\t\t\tconst shouldNotify = state === request.state;\r\n\t\t\t\t\t\t\tlet authorizationResponse: AuthorizationResponse | null = null;\r\n\t\t\t\t\t\t\tlet authorizationError: AuthorizationError | null = null;\r\n\t\t\t\t\t\t\tif (shouldNotify) {\r\n\t\t\t\t\t\t\t\tif (error) {\r\n\t\t\t\t\t\t\t\t\t// get additional optional info.\r\n\t\t\t\t\t\t\t\t\tconst errorUri = queryParams['error_uri'];\r\n\t\t\t\t\t\t\t\t\tconst errorDescription = queryParams['error_description'];\r\n\t\t\t\t\t\t\t\t\tauthorizationError = new AuthorizationError({\r\n\t\t\t\t\t\t\t\t\t\terror: error,\r\n\t\t\t\t\t\t\t\t\t\terror_description: errorDescription,\r\n\t\t\t\t\t\t\t\t\t\terror_uri: errorUri,\r\n\t\t\t\t\t\t\t\t\t\tstate: state,\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tauthorizationResponse = new AuthorizationResponse({ code: code, state: state });\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t// cleanup state\r\n\t\t\t\t\t\t\t\treturn Promise.all([\r\n\t\t\t\t\t\t\t\t\tthis.storageBackend.removeItem(AUTHORIZATION_REQUEST_HANDLE_KEY),\r\n\t\t\t\t\t\t\t\t\tthis.storageBackend.removeItem(authorizationRequestKey(handle)),\r\n\t\t\t\t\t\t\t\t\tthis.storageBackend.removeItem(authorizationServiceConfigurationKey(handle)),\r\n\t\t\t\t\t\t\t\t]).then(() => {\r\n\t\t\t\t\t\t\t\t\tlog('Delivering authorization response');\r\n\t\t\t\t\t\t\t\t\treturn {\r\n\t\t\t\t\t\t\t\t\t\trequest: request,\r\n\t\t\t\t\t\t\t\t\t\tresponse: authorizationResponse,\r\n\t\t\t\t\t\t\t\t\t\terror: authorizationError,\r\n\t\t\t\t\t\t\t\t\t} as AuthorizationRequestResponse;\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tlog('Mismatched request (state and request_uri) dont match.');\r\n\t\t\t\t\t\t\t\treturn Promise.resolve(null);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t})\r\n\t\t\t\t);\r\n\t\t\t} else {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\nimport type { StringMap } from './types.js';\r\n\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\n/**\r\n * Supported token types\r\n */\r\nexport type TokenTypeHint = 'refresh_token' | 'access_token';\r\n\r\n/**\r\n * Represents the Token Request as JSON.\r\n */\r\nexport interface RevokeTokenRequestJson {\r\n\ttoken: string;\r\n\ttoken_type_hint?: TokenTypeHint;\r\n\tclient_id?: string;\r\n\tclient_secret?: string;\r\n}\r\n\r\n/**\r\n * Represents a revoke token request.\r\n * For more information look at:\r\n * https://tools.ietf.org/html/rfc7009#section-2.1\r\n */\r\nexport class RevokeTokenRequest {\r\n\ttoken: string;\r\n\ttokenTypeHint: TokenTypeHint | undefined;\r\n\tclientId: string | undefined;\r\n\tclientSecret: string | undefined;\r\n\r\n\tconstructor(request: RevokeTokenRequestJson) {\r\n\t\tthis.token = request.token;\r\n\t\tthis.tokenTypeHint = request.token_type_hint;\r\n\t\tthis.clientId = request.client_id;\r\n\t\tthis.clientSecret = request.client_secret;\r\n\t}\r\n\r\n\t/**\r\n\t * Serializes a TokenRequest to a JavaScript object.\r\n\t */\r\n\ttoJson(): RevokeTokenRequestJson {\r\n\t\tconst json: RevokeTokenRequestJson = { token: this.token };\r\n\t\tif (this.tokenTypeHint) {\r\n\t\t\tjson['token_type_hint'] = this.tokenTypeHint;\r\n\t\t}\r\n\t\tif (this.clientId) {\r\n\t\t\tjson['client_id'] = this.clientId;\r\n\t\t}\r\n\t\tif (this.clientSecret) {\r\n\t\t\tjson['client_secret'] = this.clientSecret;\r\n\t\t}\r\n\t\treturn json;\r\n\t}\r\n\r\n\ttoStringMap(): StringMap {\r\n\t\tconst json = this.toJson();\r\n\t\t// :(\r\n\t\treturn json as any;\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/* eslint-disable local-rules/exported-string-constant-naming */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport type { StringMap } from './types.js';\r\n\r\nexport const GRANT_TYPE_AUTHORIZATION_CODE = 'authorization_code';\r\nexport const GRANT_TYPE_REFRESH_TOKEN = 'refresh_token';\r\n\r\n/**\r\n * Represents the Token Request as JSON.\r\n */\r\nexport interface TokenRequestJson {\r\n\tgrant_type: string;\r\n\tcode?: string;\r\n\trefresh_token?: string;\r\n\tredirect_uri: string;\r\n\tclient_id: string;\r\n\textras?: StringMap;\r\n}\r\n\r\n/**\r\n * Represents an Access Token request.\r\n * For more information look at:\r\n * https://tools.ietf.org/html/rfc6749#section-4.1.3\r\n */\r\nexport class TokenRequest {\r\n\tclientId: string;\r\n\tredirectUri: string;\r\n\tgrantType: string;\r\n\tcode: string | undefined;\r\n\trefreshToken: string | undefined;\r\n\textras: StringMap | undefined;\r\n\r\n\tconstructor(request: TokenRequestJson) {\r\n\t\tthis.clientId = request.client_id;\r\n\t\tthis.redirectUri = request.redirect_uri;\r\n\t\tthis.grantType = request.grant_type;\r\n\t\tthis.code = request.code;\r\n\t\tthis.refreshToken = request.refresh_token;\r\n\t\tthis.extras = request.extras;\r\n\t}\r\n\r\n\t/**\r\n\t * Serializes a TokenRequest to a JavaScript object.\r\n\t */\r\n\ttoJson(): TokenRequestJson {\r\n\t\treturn {\r\n\t\t\tgrant_type: this.grantType,\r\n\t\t\tcode: this.code,\r\n\t\t\trefresh_token: this.refreshToken,\r\n\t\t\tredirect_uri: this.redirectUri,\r\n\t\t\tclient_id: this.clientId,\r\n\t\t\textras: this.extras,\r\n\t\t};\r\n\t}\r\n\r\n\ttoStringMap(): StringMap {\r\n\t\tconst map: StringMap = {\r\n\t\t\tgrant_type: this.grantType,\r\n\t\t\tclient_id: this.clientId,\r\n\t\t\tredirect_uri: this.redirectUri,\r\n\t\t};\r\n\r\n\t\tif (this.code) {\r\n\t\t\tmap['code'] = this.code;\r\n\t\t}\r\n\r\n\t\tif (this.refreshToken) {\r\n\t\t\tmap['refresh_token'] = this.refreshToken;\r\n\t\t}\r\n\r\n\t\t// copy over extras\r\n\t\tif (this.extras) {\r\n\t\t\tfor (const extra in this.extras) {\r\n\t\t\t\tif (\r\n\t\t\t\t\tObject.prototype.hasOwnProperty.call(this.extras, extra) &&\r\n\t\t\t\t\t!Object.prototype.hasOwnProperty.call(map, extra)\r\n\t\t\t\t) {\r\n\t\t\t\t\t// check before inserting to requestMap\r\n\t\t\t\t\tmap[extra] = this.extras[extra];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn map;\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\n/**\r\n * Represents the access token types.\r\n * For more information see:\r\n * https://tools.ietf.org/html/rfc6749#section-7.1\r\n */\r\nexport type TokenType = 'bearer' | 'mac';\r\n\r\n/**\r\n * Represents the TokenResponse as a JSON Object.\r\n */\r\nexport interface TokenResponseJson {\r\n\taccess_token: string;\r\n\ttoken_type?: TokenType /* treating token type as optional, as its going to be inferred. */;\r\n\texpires_in?: string /* lifetime in seconds. */;\r\n\trefresh_token?: string;\r\n\tscope?: string;\r\n\tid_token?: string /* https://openid.net/specs/openid-connect-core-1_0.html#TokenResponse */;\r\n\tissued_at?: number /* when was it issued ? */;\r\n}\r\n\r\n/**\r\n * Represents the possible error codes from the token endpoint.\r\n * For more information look at:\r\n * https://tools.ietf.org/html/rfc6749#section-5.2\r\n */\r\nexport type ErrorType =\r\n\t| 'invalid_request'\r\n\t| 'invalid_client'\r\n\t| 'invalid_grant'\r\n\t| 'unauthorized_client'\r\n\t| 'unsupported_grant_type'\r\n\t| 'invalid_scope';\r\n\r\n/**\r\n * Represents the TokenError as a JSON Object.\r\n */\r\nexport interface TokenErrorJson {\r\n\terror: ErrorType;\r\n\terror_description?: string;\r\n\terror_uri?: string;\r\n}\r\n\r\n// constants\r\nconst AUTH_EXPIRY_BUFFER = 0; // 0 seconds buffer\r\n\r\n/**\r\n * Returns the instant of time in seconds.\r\n */\r\nexport const nowInSeconds = () => Math.round(new Date().getTime() / 1000);\r\n\r\n/**\r\n * Represents the Token Response type.\r\n * For more information look at:\r\n * https://tools.ietf.org/html/rfc6749#section-5.1\r\n */\r\nexport class TokenResponse {\r\n\taccessToken: string;\r\n\ttokenType: TokenType;\r\n\texpiresIn: number | undefined;\r\n\trefreshToken: string | undefined;\r\n\tscope: string | undefined;\r\n\tidToken: string | undefined;\r\n\tissuedAt: number;\r\n\r\n\tconstructor(response: TokenResponseJson) {\r\n\t\tthis.accessToken = response.access_token;\r\n\t\tthis.tokenType = response.token_type || 'bearer';\r\n\t\tif (response.expires_in) {\r\n\t\t\tthis.expiresIn = parseInt(response.expires_in, 10);\r\n\t\t}\r\n\t\tthis.refreshToken = response.refresh_token;\r\n\t\tthis.scope = response.scope;\r\n\t\tthis.idToken = response.id_token;\r\n\t\tthis.issuedAt = response.issued_at || nowInSeconds();\r\n\t}\r\n\r\n\ttoJson(): TokenResponseJson {\r\n\t\treturn {\r\n\t\t\taccess_token: this.accessToken,\r\n\t\t\tid_token: this.idToken,\r\n\t\t\trefresh_token: this.refreshToken,\r\n\t\t\tscope: this.scope,\r\n\t\t\ttoken_type: this.tokenType,\r\n\t\t\tissued_at: this.issuedAt,\r\n\t\t\texpires_in: this.expiresIn?.toString(),\r\n\t\t};\r\n\t}\r\n\r\n\tisValid(buffer: number = AUTH_EXPIRY_BUFFER): boolean {\r\n\t\tif (this.expiresIn) {\r\n\t\t\tconst now = nowInSeconds();\r\n\t\t\treturn now < this.issuedAt + this.expiresIn + buffer;\r\n\t\t} else {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * Represents the Token Error type.\r\n * For more information look at:\r\n * https://tools.ietf.org/html/rfc6749#section-5.2\r\n */\r\nexport class TokenError {\r\n\terror: ErrorType;\r\n\terrorDescription: string | undefined;\r\n\terrorUri: string | undefined;\r\n\r\n\tconstructor(tokenError: TokenErrorJson) {\r\n\t\tthis.error = tokenError.error;\r\n\t\tthis.errorDescription = tokenError.error_description;\r\n\t\tthis.errorUri = tokenError.error_uri;\r\n\t}\r\n\r\n\ttoJson(): TokenErrorJson {\r\n\t\treturn {\r\n\t\t\terror: this.error,\r\n\t\t\terror_description: this.errorDescription,\r\n\t\t\terror_uri: this.errorUri,\r\n\t\t};\r\n\t}\r\n}\r\n","/* eslint-disable local-rules/umb-class-prefix */\r\n/*\r\n * Copyright 2017 Google Inc.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except\r\n * in compliance with the License. You may obtain a copy of the License at\r\n *\r\n * http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software distributed under the\r\n * License is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\r\n * express or implied. See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport type { AuthorizationServiceConfiguration } from './authorization_service_configuration.js';\r\nimport { AppAuthError } from './errors.js';\r\nimport { BasicQueryStringUtils } from './query_string_utils.js';\r\nimport type { QueryStringUtils } from './query_string_utils.js';\r\nimport type { RevokeTokenRequest } from './revoke_token_request.js';\r\nimport type { TokenRequest } from './token_request.js';\r\nimport { TokenError, TokenResponse } from './token_response.js';\r\nimport type { TokenErrorJson, TokenResponseJson } from './token_response.js';\r\nimport { FetchRequestor, type Requestor } from './xhr.js';\r\n\r\n/**\r\n * Represents an interface which can make a token request.\r\n */\r\nexport interface TokenRequestHandler {\r\n\t/**\r\n\t * Performs the token request, given the service configuration.\r\n\t */\r\n\tperformTokenRequest(configuration: AuthorizationServiceConfiguration, request: TokenRequest): Promise<TokenResponse>;\r\n\r\n\tperformRevokeTokenRequest(\r\n\t\tconfiguration: AuthorizationServiceConfiguration,\r\n\t\trequest: RevokeTokenRequest,\r\n\t): Promise<boolean>;\r\n}\r\n\r\n/**\r\n * The default token request handler.\r\n */\r\nexport class BaseTokenRequestHandler implements TokenRequestHandler {\r\n\tconstructor(\r\n\t\tpublic readonly requestor: Requestor = new FetchRequestor(),\r\n\t\tpublic readonly utils: QueryStringUtils = new BasicQueryStringUtils(),\r\n\t) {}\r\n\r\n\tprivate isTokenResponse(response: TokenResponseJson | TokenErrorJson): response is TokenResponseJson {\r\n\t\treturn (response as TokenErrorJson).error === undefined;\r\n\t}\r\n\r\n\tperformRevokeTokenRequest(\r\n\t\tconfiguration: AuthorizationServiceConfiguration,\r\n\t\trequest: RevokeTokenRequest,\r\n\t): Promise<boolean> {\r\n\t\tconst revokeTokenResponse = this.requestor.xhr<boolean>({\r\n\t\t\turl: configuration.revocationEndpoint,\r\n\t\t\tmethod: 'POST',\r\n\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n\t\t\tdata: this.utils.stringify(request.toStringMap()),\r\n\t\t});\r\n\r\n\t\treturn revokeTokenResponse.then((response) => {\r\n\t\t\treturn true;\r\n\t\t});\r\n\t}\r\n\r\n\tperformTokenRequest(configuration: AuthorizationServiceConfiguration, request: TokenRequest): Promise<TokenResponse> {\r\n\t\tconst tokenResponse = this.requestor.xhr<TokenResponseJson | TokenErrorJson>({\r\n\t\t\turl: configuration.tokenEndpoint,\r\n\t\t\tmethod: 'POST',\r\n\t\t\tdataType: 'json', // adding implicit dataType\r\n\t\t\theaders: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n\t\t\tdata: this.utils.stringify(request.toStringMap()),\r\n\t\t});\r\n\r\n\t\treturn tokenResponse.then((response) => {\r\n\t\t\tif (this.isTokenResponse(response)) {\r\n\t\t\t\treturn new TokenResponse(response);\r\n\t\t\t} else {\r\n\t\t\t\treturn Promise.reject<TokenResponse>(new AppAuthError(response.error, new TokenError(response)));\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n"],"names":["lookup","code","i","len","tripletToBase64","num","encodeChunk","uint8","start","end","tmp","output","fromByteArray","extraBytes","parts","maxChunkLength","len2","AppAuthError","message","extras","HAS_CRYPTO","HAS_SUBTLE_CRYPTO","CHARSET","bufferToString","buffer","state","index","urlSafe","textEncodeLite","str","buf","bufView","DefaultCrypto","size","resolve","reject","error","IS_LOG","IS_PROFILE","log","args","profile","target","propertyKey","descriptor","SIZE","newState","crypto","AuthorizationRequest","request","usePkce","codeVerifier","result","AuthorizationNotifier","listener","response","BUILT_IN_PARAMETERS","AuthorizationRequestHandler","utils","configuration","requestMap","extra","query","notifier","AuthorizationResponse","AuthorizationError","Requestor","FetchRequestor","settings","url","requestInit","value","key","isJsonDataType","contentType","WELL_KNOWN_PATH","OPENID_CONFIGURATION","AuthorizationServiceConfiguration","openIdIssuerUrl","requestor","fullUrl","json","BasicQueryStringUtils","input","useHash","params","encoded","StorageBackend","LocalStorageBackend","storage","name","authorizationRequestKey","handle","authorizationServiceConfigurationKey","AUTHORIZATION_REQUEST_HANDLE_KEY","RedirectRequestHandler","storageBackend","locationLike","currentUri","queryParams","shouldNotify","authorizationResponse","authorizationError","errorUri","errorDescription","RevokeTokenRequest","GRANT_TYPE_AUTHORIZATION_CODE","GRANT_TYPE_REFRESH_TOKEN","TokenRequest","map","AUTH_EXPIRY_BUFFER","nowInSeconds","TokenResponse","TokenError","tokenError","BaseTokenRequestHandler"],"mappings":"AAQA,MAAMA,IAAmB,CAAC,GAIpBC,IAAO;AACb,SAASC,IAAI,GAAGC,IAAMF,EAAK,QAAQC,IAAIC,GAAK,EAAED;AACtC,EAAAF,EAAAE,CAAC,IAAID,EAAKC,CAAC;AA0FnB,SAASE,EAAgBC,GAAa;AACrC,SAAOL,EAAQK,KAAO,KAAM,EAAI,IAAIL,EAAQK,KAAO,KAAM,EAAI,IAAIL,EAAQK,KAAO,IAAK,EAAI,IAAIL,EAAOK,IAAM,EAAI;AAC/G;AAEA,SAASC,EAAYC,GAAmBC,GAAeC,GAAa;AAGnE,WAFIC,GACAC,IAAS,CAAC,GACLT,IAAIM,GAAON,IAAIO,GAAKP,KAAK;AACjC,IAAAQ,KAAQH,EAAML,CAAC,KAAK,KAAM,aAAcK,EAAML,IAAI,CAAC,KAAK,IAAK,UAAWK,EAAML,IAAI,CAAC,IAAI,MAChFS,EAAA,KAAKP,EAAgBM,CAAG,CAAC;AAE1B,SAAAC,EAAO,KAAK,EAAE;AACtB;AAOO,SAASC,EAAcL,GAA2B;AAQ/C,WAPLG,GACAP,IAAMI,EAAM,QACZM,IAAaV,IAAM,GACnBW,IAAQ,CAAC,GACTC,IAAiB,OAGZ,IAAI,GAAGC,IAAOb,IAAMU,GAAY,IAAIG,GAAM,KAAKD;AACjD,IAAAD,EAAA,KAAKR,EAAYC,GAAO,GAAG,IAAIQ,IAAiBC,IAAOA,IAAO,IAAID,CAAc,CAAC;AAIxF,SAAIF,MAAe,KACZH,IAAAH,EAAMJ,IAAM,CAAC,GACbW,EAAA,KAAKd,EAAOU,KAAO,CAAC,IAAIV,EAAQU,KAAO,IAAK,EAAI,IAAI,IAAI,KACpDG,MAAe,MACzBH,KAAOH,EAAMJ,IAAM,CAAC,KAAK,KAAKI,EAAMJ,IAAM,CAAC,GAC3CW,EAAM,KAAKd,EAAOU,KAAO,EAAE,IAAIV,EAAQU,KAAO,IAAK,EAAI,IAAIV,EAAQU,KAAO,IAAK,EAAI,IAAI,GAAG,IAGpFI,EAAM,KAAK,EAAE;AACrB;AC/HO,MAAMG,EAAa;AAAA,EACzB,YACQC,GACAC,GACN;AAFM,SAAA,UAAAD,GACA,KAAA,SAAAC;AAAA,EAAA;AAET;ACLA,MAAMC,IAAa,OAAO,SAAW,OAAe,CAAC,CAAE,OAAO,QACxDC,IAAoBD,KAAc,CAAC,CAAE,OAAO,OAAO,QACnDE,IAAU;AAET,SAASC,EAAeC,GAAoB;AAClD,QAAMC,IAAQ,CAAC;AACf,WAASvB,IAAI,GAAGA,IAAIsB,EAAO,YAAYtB,KAAK,GAAG;AAC9C,UAAMwB,IAAQF,EAAOtB,CAAC,IAAIoB,EAAQ;AAC5B,IAAAG,EAAA,KAAKH,EAAQI,CAAK,CAAC;AAAA,EAAA;AAEnB,SAAAD,EAAM,KAAK,EAAE;AACrB;AAEO,SAASE,EAAQH,GAA4B;AAE5C,SADSZ,EAAc,IAAI,WAAWY,CAAM,CAAC,EACrC,QAAQ,OAAO,GAAG,EAAE,QAAQ,OAAO,GAAG,EAAE,QAAQ,MAAM,EAAE;AACxE;AAKO,SAASI,EAAeC,GAAa;AAC3C,QAAMC,IAAM,IAAI,YAAYD,EAAI,MAAM,GAChCE,IAAU,IAAI,WAAWD,CAAG;AAElC,WAAS5B,IAAI,GAAGA,IAAI2B,EAAI,QAAQ3B;AAC/B,IAAA6B,EAAQ7B,CAAC,IAAI2B,EAAI,WAAW3B,CAAC;AAEvB,SAAA6B;AACR;AAkBO,MAAMC,EAAgC;AAAA,EAC5C,eAAeC,GAAc;AACtB,UAAAT,IAAS,IAAI,WAAWS,CAAI;AAClC,QAAIb;AACI,aAAA,OAAO,gBAAgBI,CAAM;AAAA;AAGpC,eAAStB,IAAI,GAAGA,IAAI+B,GAAM/B,KAAK;AAC9B,QAAAsB,EAAOtB,CAAC,IAAK,KAAK,OAAO,IAAIoB,EAAQ,SAAU;AAGjD,WAAOC,EAAeC,CAAM;AAAA,EAAA;AAAA,EAG7B,gBAAgBvB,GAA+B;AAC9C,WAAIA,EAAK,SAAS,MAAMA,EAAK,SAAS,MAC9B,QAAQ,OAAO,IAAIgB,EAAa,sBAAsB,CAAC,IAE1DI,IAIE,IAAI,QAAQ,CAACa,GAASC,MAAW;AACvC,aAAO,OAAO,OAAO,WAAWP,EAAe3B,CAAI,CAAC,EAAE;AAAA,QACrD,CAACuB,MACOU,EAAQP,EAAQ,IAAI,WAAWH,CAAM,CAAC,CAAC;AAAA,QAE/C,CAACY,MAAUD,EAAOC,CAAK;AAAA,MACxB;AAAA,IAAA,CACA,IAVO,QAAQ,OAAO,IAAInB,EAAa,sCAAsC,CAAC;AAAA,EAU9E;AAEH;AC/EO,MAAMoB,IAAS,IAGTC,IAAa;ACJV,SAAAC,EAAIrB,MAAoBsB,GAAa;AAGnD,GADeA,IAAOA,EAAK,SAAS,KACvB,IACJ,QAAA,IAAItB,GAAS,GAAGsB,CAAI,IAE5B,QAAQ,IAAItB,CAAO;AAGtB;AAQgB,SAAAuB,EAAQC,GAAaC,GAAqBC,GAAgC;AAKjF,SAAAA;AAET;ACJA,MAAMC,IAAO,IACPC,IAAW,SAAUC,GAAwB;AAC3C,SAAAA,EAAO,eAAeF,CAAI;AAClC;AAOO,MAAMG,EAAqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAoBjC,YACCC,GACQF,IAAiB,IAAIf,EAAc,GACnCkB,IAAmB,IAC1B;AAFO,SAAA,SAAAH,GACA,KAAA,UAAAG,GAER,KAAK,WAAWD,EAAQ,WACxB,KAAK,cAAcA,EAAQ,cAC3B,KAAK,QAAQA,EAAQ,OAChB,KAAA,eAAeA,EAAQ,iBAAiBD,EAAqB,oBAClE,KAAK,QAAQC,EAAQ,SAASH,EAASC,CAAM,GAC7C,KAAK,SAASE,EAAQ,QAEtB,KAAK,WAAWA,EAAQ;AAAA,EAAA;AAAA,EA/BzB,OAAA;AAAA,SAAO,sBAAsB;AAAA,EAAA;AAAA,EAC7B,OAAA;AAAA,SAAO,qBAAqB;AAAA,EAAA;AAAA,EAiC5B,oBAAmC;AAC9B,QAAC,KAAK,SAEH;AACN,YAAME,IAAe,KAAK,OAAO,eAAe,GAAG;AAK5C,aAJwC,KAAK,OAAO,gBAAgBA,CAAY,EAAE,MAAM,CAACf,MAAU;AACzG,QAAAG,EAAI,qDAAqDH,CAAK;AAAA,MACvD,CACP,EACgB,KAAK,CAACgB,MAAW;AACjC,QAAIA,MAEE,KAAA,WAAW,KAAK,YAAY,CAAC,GAC7B,KAAA,SAAS,gBAAmBD,GAC5B,KAAA,SAAS,KAAK,UAAU,CAAC,GACzB,KAAA,OAAO,iBAAoBC,GAE3B,KAAA,OAAO,wBAA2B;AAAA,MACxC,CACA;AAAA,IAAA;AAjBD,aAAO,QAAQ,QAAQ;AAAA,EAkBxB;AAAA;AAAA;AAAA;AAAA,EAMD,SAA4C;AAE3C,WAAO,KAAK,oBAAoB,KAAK,OAC7B;AAAA,MACN,eAAe,KAAK;AAAA,MACpB,WAAW,KAAK;AAAA,MAChB,cAAc,KAAK;AAAA,MACnB,OAAO,KAAK;AAAA,MACZ,OAAO,KAAK;AAAA,MACZ,QAAQ,KAAK;AAAA,MACb,UAAU,KAAK;AAAA,IAChB,EACA;AAAA,EAAA;AAEH;AC3EO,MAAMC,GAAsB;AAAA,EAA5B,cAAA;AACN,SAAQ,WAAyC;AAAA,EAAA;AAAA,EAEjD,yBAAyBC,GAAiC;AACzD,SAAK,WAAWA;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA,EAMjB,wBACCL,GACAM,GACAnB,GACO;AACP,IAAI,KAAK,YAEH,KAAA,SAASa,GAASM,GAAUnB,CAAK;AAAA,EACvC;AAEF;AAIO,MAAMoB,IAAsB,CAAC,gBAAgB,aAAa,iBAAiB,SAAS,OAAO;AAM3F,MAAeC,EAA4B;AAAA,EACjD,YACQC,GACGX,GACT;AAFM,SAAA,QAAAW,GACG,KAAA,SAAAX,GAIX,KAAU,WAAyC;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA,EAKzC,gBAAgBY,GAAkDV,GAA+B;AAG1G,UAAMW,IAAwB;AAAA,MAC7B,cAAcX,EAAQ;AAAA,MACtB,WAAWA,EAAQ;AAAA,MACnB,eAAeA,EAAQ;AAAA,MACvB,OAAOA,EAAQ;AAAA,MACf,OAAOA,EAAQ;AAAA,IAChB;AAGA,QAAIA,EAAQ;AACA,iBAAAY,KAASZ,EAAQ;AAC3B,QAAI,OAAO,UAAU,eAAe,KAAKA,EAAQ,QAAQY,CAAK,KAEzDL,EAAoB,QAAQK,CAAK,IAAI,MACxCD,EAAWC,CAAK,IAAIZ,EAAQ,OAAOY,CAAK;AAM5C,UAAMC,IAAQ,KAAK,MAAM,UAAUF,CAAU;AAGtC,WADK,GADID,EAAc,qBACR,IAAIG,CAAK;AAAA,EACxB;AAAA;AAAA;AAAA;AAAA,EAMR,yCAAwD;AAGvD,WAAAvB,EAAI,wEAAwE,GACvE,KAAK,YACLA,EAAA;AAAA,iDAC0C,GAExC,KAAK,6BAAA,EAA+B,KAAK,CAACa,MAAW;AAC3D,MAAKA,KACJb,EAAI,6BAA6B,GAE9Ba,KAAU,KAAK,YAClB,KAAK,SAAS,wBAAwBA,EAAO,SAASA,EAAO,UAAUA,EAAO,KAAK;AAAA,IACpF,CACA;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA,EAMF,yBAAyBW,GAA8D;AACtF,gBAAK,WAAWA,GACT;AAAA,EAAA;AAiBT;AC1HO,MAAMC,EAAsB;AAAA,EAIlC,YAAYT,GAAqC;AAChD,SAAK,OAAOA,EAAS,MACrB,KAAK,QAAQA,EAAS;AAAA,EAAA;AAAA,EAGvB,SAAoC;AACnC,WAAO,EAAE,MAAM,KAAK,MAAM,OAAO,KAAK,MAAM;AAAA,EAAA;AAE9C;AAOO,MAAMU,EAAmB;AAAA,EAM/B,YAAY7B,GAA+B;AAC1C,SAAK,QAAQA,EAAM,OACnB,KAAK,mBAAmBA,EAAM,mBAC9B,KAAK,WAAWA,EAAM,WACtB,KAAK,QAAQA,EAAM;AAAA,EAAA;AAAA,EAGpB,SAAiC;AACzB,WAAA;AAAA,MACN,OAAO,KAAK;AAAA,MACZ,mBAAmB,KAAK;AAAA,MACxB,WAAW,KAAK;AAAA,MAChB,OAAO,KAAK;AAAA,IACb;AAAA,EAAA;AAEF;ACzDO,MAAe8B,EAAU;AAEhC;AAKO,MAAMC,UAAuBD,EAAU;AAAA,EAC7C,IAAOE,GAAsC;AACxC,QAAA,CAACA,EAAS;AACb,aAAO,QAAQ,OAAO,IAAInD,EAAa,yBAAyB,CAAC;AAElE,UAAMoD,IAAW,IAAI,IAAYD,EAAS,GAAG,GACvCE,IAA2B,CAAC;AAClC,IAAAA,EAAY,SAASF,EAAS,QAC9BE,EAAY,OAAO,QAEfF,EAAS,SACRA,EAAS,UAAUA,EAAS,OAAO,kBAAkB,SACxDE,EAAY,OAAeF,EAAS,OAEf,IAAI,gBAAgBA,EAAS,IAAI,EACzC,QAAQ,CAACG,GAAOC,MAAQ;AAChC,MAAAH,EAAA,aAAa,OAAOG,GAAKD,CAAK;AAAA,IAAA,CAClC,IAKHD,EAAY,UAAU,CAAC,GACnBF,EAAS,YACZE,EAAY,UAAUF,EAAS;AAGhC,UAAMK,IAAiBL,EAAS,YAAYA,EAAS,SAAS,kBAAkB;AAKhF,WAAIK,MACFH,EAAY,QAAgB,SAAS,mDAGhC,MAAMD,EAAI,SAAS,GAAGC,CAAW,EAAE,KAAK,CAACf,MAAa;AAC5D,UAAIA,EAAS,UAAU,OAAOA,EAAS,SAAS,KAAK;AACpD,cAAMmB,IAAcnB,EAAS,QAAQ,IAAI,cAAc;AACvD,eAAIkB,KAAmBC,KAAeA,EAAY,QAAQ,kBAAkB,MAAM,KAC1EnB,EAAS,KAAK,IAEdA,EAAS,KAAK;AAAA,MACtB;AAEO,eAAA,QAAQ,OAAO,IAAItC,EAAasC,EAAS,OAAO,SAAS,GAAGA,EAAS,UAAU,CAAC;AAAA,IACxF,CACA;AAAA,EAAA;AAEH;AC5CA,MAAMoB,IAAkB,eAMlBC,IAAuB;AAOtB,MAAMC,EAAkC;AAAA,EAO9C,YAAY5B,GAAgD;AAC3D,SAAK,wBAAwBA,EAAQ,wBACrC,KAAK,gBAAgBA,EAAQ,gBAC7B,KAAK,qBAAqBA,EAAQ,qBAClC,KAAK,mBAAmBA,EAAQ,mBAChC,KAAK,qBAAqBA,EAAQ;AAAA,EAAA;AAAA,EAGnC,SAAS;AACD,WAAA;AAAA,MACN,wBAAwB,KAAK;AAAA,MAC7B,gBAAgB,KAAK;AAAA,MACrB,qBAAqB,KAAK;AAAA,MAC1B,sBAAsB,KAAK;AAAA,MAC3B,mBAAmB,KAAK;AAAA,IACzB;AAAA,EAAA;AAAA,EAGD,OAAO,gBAAgB6B,GAAyBC,GAAmE;AAClH,UAAMC,IAAU,GAAGF,CAAe,IAAIH,CAAe,IAAIC,CAAoB;AAI7E,YAFuBG,KAAa,IAAIZ,EAAe,GAGrD,IAA2C,EAAE,KAAKa,GAAS,UAAU,QAAQ,QAAQ,MAAO,CAAA,EAC5F,KAAK,CAACC,MAAS,IAAIJ,EAAkCI,CAAI,CAAC;AAAA,EAAA;AAE9D;ACtDO,MAAMC,EAAkD;AAAA,EAC9D,MAAMC,GAAqBC,GAAmB;AAC7C,WAAIA,IACI,KAAK,iBAAiBD,EAAM,IAAI,IAEhC,KAAK,iBAAiBA,EAAM,MAAM;AAAA,EAC1C;AAAA,EAGD,iBAAiBrB,GAA0B;AAC1C,UAAMV,IAAoB,CAAC;AAE3B,IAAAU,IAAQA,EAAM,KAAA,EAAO,QAAQ,aAAa,EAAE;AACtC,UAAAuB,IAASvB,EAAM,MAAM,GAAG;AAC9B,aAAS5D,IAAI,GAAGA,IAAImF,EAAO,QAAQnF,KAAK,GAAG;AAEpC,YAAAY,IADQuE,EAAOnF,CAAC,EACF,MAAM,GAAG;AACzB,UAAAY,EAAM,UAAU,GAAG;AACtB,cAAM0D,IAAM,mBAAmB1D,EAAM,MAAA,CAAQ,GACvCyD,IAAQzD,EAAM,SAAS,IAAIA,EAAM,KAAK,GAAG,IAAI;AACnD,QAAIyD,MACInB,EAAAoB,CAAG,IAAI,mBAAmBD,CAAK;AAAA,MACvC;AAAA,IACD;AAEM,WAAAnB;AAAA,EAAA;AAAA,EAGR,UAAU+B,GAAkB;AAC3B,UAAMG,IAAoB,CAAC;AAC3B,eAAWd,KAAOW;AACb,MAAA,OAAO,UAAU,eAAe,KAAKA,GAAOX,CAAG,KAAKW,EAAMX,CAAG,KACxDc,EAAA,KAAK,GAAG,mBAAmBd,CAAG,CAAC,IAAI,mBAAmBW,EAAMX,CAAG,CAAC,CAAC,EAAE;AAGtE,WAAAc,EAAQ,KAAK,GAAG;AAAA,EAAA;AAEzB;AC5BO,MAAeC,EAAe;AAsBrC;AAKO,MAAMC,UAA4BD,EAAe;AAAA,EAEvD,YAAYE,GAA6B;AAClC,UAAA,GACD,KAAA,UAAUA,KAAW,OAAO;AAAA,EAAA;AAAA,EAG3B,QAAQC,GAAsC;AACpD,WAAO,IAAI,QAAuB,CAACxD,GAASC,MAAW;AACtD,YAAMoC,IAAQ,KAAK,QAAQ,QAAQmB,CAAI;AACvC,MACCxD,EADGqC,KAGK,IAFK;AAAA,IAGd,CACA;AAAA,EAAA;AAAA,EAGK,WAAWmB,GAA6B;AAC9C,WAAO,IAAI,QAAc,CAACxD,GAASC,MAAW;AACxC,WAAA,QAAQ,WAAWuD,CAAI,GACpBxD,EAAA;AAAA,IAAA,CACR;AAAA,EAAA;AAAA,EAGK,QAAuB;AAC7B,WAAO,IAAI,QAAc,CAACA,GAASC,MAAW;AAC7C,WAAK,QAAQ,MAAM,GACXD,EAAA;AAAA,IAAA,CACR;AAAA,EAAA;AAAA,EAGK,QAAQwD,GAAcnB,GAA8B;AAC1D,WAAO,IAAI,QAAc,CAACrC,GAASC,MAAW;AACxC,WAAA,QAAQ,QAAQuD,GAAMnB,CAAK,GACxBrC,EAAA;AAAA,IAAA,CACR;AAAA,EAAA;AAEH;ACvEA,MAAMyD,IAA0B,CAACC,MACzB,GAAGA,CAAM,kCAIXC,IAAuC,CAACD,MACtC,GAAGA,CAAM,gDAIXE,IAAmC;AAMlC,MAAMC,WAA+BtC,EAA4B;AAAA,EACvE,YAIQuC,IAAiC,IAAIR,KAC5C9B,IAAQ,IAAIwB,KACLe,IAA6B,OAAO,UAC3ClD,IAAiB,IAAIf,KACpB;AACD,UAAM0B,GAAOX,CAAM,GALZ,KAAA,iBAAAiD,GAEA,KAAA,eAAAC;AAAA,EAAA;AAAA,EAMR,4BAA4BtC,GAAkDV,GAA+B;AAC5G,UAAM2C,IAAS,KAAK,OAAO,eAAe,EAAE;AAYrC,WATW,QAAQ,IAAI;AAAA,MAC7B,KAAK,eAAe,QAAQE,GAAkCF,CAAM;AAAA;AAAA,MAEpE3C,EACE,OAAO,EACP,KAAK,CAACG,MAAW,KAAK,eAAe,QAAQuC,EAAwBC,CAAM,GAAG,KAAK,UAAUxC,CAAM,CAAC,CAAC;AAAA,MACvG,KAAK,eAAe,QAAQyC,EAAqCD,CAAM,GAAG,KAAK,UAAUjC,EAAc,QAAQ,CAAC;AAAA,IAAA,CAChH,EAEgB,KAAK,MAAM;AAE3B,YAAMU,IAAM,KAAK,gBAAgBV,GAAeV,CAAO;AACnD,aAAAV,EAAA,wBAAwBU,GAASoB,CAAG,GACjCA;AAAA,IAAA,CACP;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOQ,+BAA6E;AAEtF,WAAO,KAAK,eAAe,QAAQyB,CAAgC,EAAE,KAAK,CAACF,MACtEA,IAIF,KAAK,eACH,QAAQD,EAAwBC,CAAM,CAAC,EAGvC,KAAK,CAACxC,MAAW,KAAK,MAAMA,CAAO,CAAC,EACpC,KAAK,CAAC6B,MAAS,IAAIjC,EAAqBiC,CAAI,CAAC,EAC7C,KAAK,CAAChC,MAAY;AAEZ,YAAAiD,IAAa,GAAG,KAAK,aAAa,MAAM,GAAG,KAAK,aAAa,QAAQ,IACrEC,IAAc,KAAK,MAAM;AAAA,QAAM,KAAK;AAAA,QAAc;AAAA;AAAA,MAAmB,GACrE1E,IAA4B0E,EAAY,OACxClG,IAA2BkG,EAAY,MACvC/D,IAA4B+D,EAAY;AAC9C,MAAA5D,EAAI,oCAAoC2D,GAAYC,GAAa1E,GAAOxB,GAAMmC,CAAK;AAC7E,YAAAgE,IAAe3E,MAAUwB,EAAQ;AACvC,UAAIoD,IAAsD,MACtDC,IAAgD;AACpD,UAAIF,GAAc;AACjB,YAAIhE,GAAO;AAEJ,gBAAAmE,IAAWJ,EAAY,WACvBK,IAAmBL,EAAY;AACrC,UAAAG,IAAqB,IAAIrC,EAAmB;AAAA,YAC3C,OAAA7B;AAAA,YACA,mBAAmBoE;AAAA,YACnB,WAAWD;AAAA,YACX,OAAA9E;AAAA,UAAA,CACA;AAAA,QAAA;AAED,UAAA4E,IAAwB,IAAIrC,EAAsB,EAAE,MAAA/D,GAAY,OAAAwB,GAAc;AAG/E,eAAO,QAAQ,IAAI;AAAA,UAClB,KAAK,eAAe,WAAWqE,CAAgC;AAAA,UAC/D,KAAK,eAAe,WAAWH,EAAwBC,CAAM,CAAC;AAAA,UAC9D,KAAK,eAAe,WAAWC,EAAqCD,CAAM,CAAC;AAAA,QAAA,CAC3E,EAAE,KAAK,OACPrD,EAAI,mCAAmC,GAChC;AAAA,UACN,SAAAU;AAAA,UACA,UAAUoD;AAAA,UACV,OAAOC;AAAA,QACR,EACA;AAAA,MAAA;AAED,eAAA/D,EAAI,wDAAwD,GACrD,QAAQ,QAAQ,IAAI;AAAA,IAC5B,CACA,IAGI,IAER;AAAA,EAAA;AAEH;AC5GO,MAAMkE,GAAmB;AAAA,EAM/B,YAAYxD,GAAiC;AAC5C,SAAK,QAAQA,EAAQ,OACrB,KAAK,gBAAgBA,EAAQ,iBAC7B,KAAK,WAAWA,EAAQ,WACxB,KAAK,eAAeA,EAAQ;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA,EAM7B,SAAiC;AAChC,UAAMgC,IAA+B,EAAE,OAAO,KAAK,MAAM;AACzD,WAAI,KAAK,kBACHA,EAAA,kBAAqB,KAAK,gBAE5B,KAAK,aACHA,EAAA,YAAe,KAAK,WAEtB,KAAK,iBACHA,EAAA,gBAAmB,KAAK,eAEvBA;AAAA,EAAA;AAAA,EAGR,cAAyB;AAGjB,WAFM,KAAK,OAAO;AAAA,EAElB;AAET;ACtDO,MAAMyB,KAAgC,sBAChCC,KAA2B;AAmBjC,MAAMC,GAAa;AAAA,EAQzB,YAAY3D,GAA2B;AACtC,SAAK,WAAWA,EAAQ,WACxB,KAAK,cAAcA,EAAQ,cAC3B,KAAK,YAAYA,EAAQ,YACzB,KAAK,OAAOA,EAAQ,MACpB,KAAK,eAAeA,EAAQ,eAC5B,KAAK,SAASA,EAAQ;AAAA,EAAA;AAAA;AAAA;AAAA;AAAA,EAMvB,SAA2B;AACnB,WAAA;AAAA,MACN,YAAY,KAAK;AAAA,MACjB,MAAM,KAAK;AAAA,MACX,eAAe,KAAK;AAAA,MACpB,cAAc,KAAK;AAAA,MACnB,WAAW,KAAK;AAAA,MAChB,QAAQ,KAAK;AAAA,IACd;AAAA,EAAA;AAAA,EAGD,cAAyB;AACxB,UAAM4D,IAAiB;AAAA,MACtB,YAAY,KAAK;AAAA,MACjB,WAAW,KAAK;AAAA,MAChB,cAAc,KAAK;AAAA,IACpB;AAWA,QATI,KAAK,SACJA,EAAA,OAAU,KAAK,OAGhB,KAAK,iBACJA,EAAA,gBAAmB,KAAK,eAIzB,KAAK;AACG,iBAAAhD,KAAS,KAAK;AACxB,QACC,OAAO,UAAU,eAAe,KAAK,KAAK,QAAQA,CAAK,KACvD,CAAC,OAAO,UAAU,eAAe,KAAKgD,GAAKhD,CAAK,MAGhDgD,EAAIhD,CAAK,IAAI,KAAK,OAAOA,CAAK;AAI1B,WAAAgD;AAAA,EAAA;AAET;ACxCA,MAAMC,IAAqB,GAKdC,IAAe,MAAM,KAAK,2BAAU,KAAK,GAAE,QAAQ,IAAI,GAAI;AAOjE,MAAMC,EAAc;AAAA,EAS1B,YAAYzD,GAA6B;AACxC,SAAK,cAAcA,EAAS,cACvB,KAAA,YAAYA,EAAS,cAAc,UACpCA,EAAS,eACZ,KAAK,YAAY,SAASA,EAAS,YAAY,EAAE,IAElD,KAAK,eAAeA,EAAS,eAC7B,KAAK,QAAQA,EAAS,OACtB,KAAK,UAAUA,EAAS,UACnB,KAAA,WAAWA,EAAS,aAAawD,EAAa;AAAA,EAAA;AAAA,EAGpD,SAA4B;AACpB,WAAA;AAAA,MACN,cAAc,KAAK;AAAA,MACnB,UAAU,KAAK;AAAA,MACf,eAAe,KAAK;AAAA,MACpB,OAAO,KAAK;AAAA,MACZ,YAAY,KAAK;AAAA,MACjB,WAAW,KAAK;AAAA,MAChB,YAAY,KAAK,WAAW,SAAS;AAAA,IACtC;AAAA,EAAA;AAAA,EAGD,QAAQvF,IAAiBsF,GAA6B;AACrD,WAAI,KAAK,YACIC,EAAa,IACZ,KAAK,WAAW,KAAK,YAAYvF,IAEvC;AAAA,EACR;AAEF;AAOO,MAAMyF,EAAW;AAAA,EAKvB,YAAYC,GAA4B;AACvC,SAAK,QAAQA,EAAW,OACxB,KAAK,mBAAmBA,EAAW,mBACnC,KAAK,WAAWA,EAAW;AAAA,EAAA;AAAA,EAG5B,SAAyB;AACjB,WAAA;AAAA,MACN,OAAO,KAAK;AAAA,MACZ,mBAAmB,KAAK;AAAA,MACxB,WAAW,KAAK;AAAA,IACjB;AAAA,EAAA;AAEF;AC7FO,MAAMC,GAAuD;AAAA,EACnE,YACiBpC,IAAuB,IAAIZ,KAC3BT,IAA0B,IAAIwB,KAC7C;AAFe,SAAA,YAAAH,GACA,KAAA,QAAArB;AAAA,EAAA;AAAA,EAGT,gBAAgBH,GAA6E;AACpG,WAAQA,EAA4B,UAAU;AAAA,EAAA;AAAA,EAG/C,0BACCI,GACAV,GACmB;AAQZ,WAPqB,KAAK,UAAU,IAAa;AAAA,MACvD,KAAKU,EAAc;AAAA,MACnB,QAAQ;AAAA,MACR,SAAS,EAAE,gBAAgB,oCAAoC;AAAA,MAC/D,MAAM,KAAK,MAAM,UAAUV,EAAQ,YAAa,CAAA;AAAA,IAAA,CAChD,EAE0B,KAAK,CAACM,MACzB,EACP;AAAA,EAAA;AAAA,EAGF,oBAAoBI,GAAkDV,GAA+C;AAS7G,WARe,KAAK,UAAU,IAAwC;AAAA,MAC5E,KAAKU,EAAc;AAAA,MACnB,QAAQ;AAAA,MACR,UAAU;AAAA;AAAA,MACV,SAAS,EAAE,gBAAgB,oCAAoC;AAAA,MAC/D,MAAM,KAAK,MAAM,UAAUV,EAAQ,YAAa,CAAA;AAAA,IAAA,CAChD,EAEoB,KAAK,CAACM,MACtB,KAAK,gBAAgBA,CAAQ,IACzB,IAAIyD,EAAczD,CAAQ,IAE1B,QAAQ,OAAsB,IAAItC,EAAasC,EAAS,OAAO,IAAI0D,EAAW1D,CAAQ,CAAC,CAAC,CAEhG;AAAA,EAAA;AAEH;"}