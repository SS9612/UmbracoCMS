@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<Umbraco.Cms.Core.Models.Blocks.BlockListItem>
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Extensions;
@using UmbracoCMS.ViewModels;
@using UmbracoCMS.Controllers;
@using Umbraco.Cms.Core.Models.PublishedContent;
@using System.Linq;

@{
    var content = (ContentModels.CallbackRequestSection)Model.Content;

    var eyebrow = !string.IsNullOrWhiteSpace(content.CallbackEyebrow)
        ? content.CallbackEyebrow
        : "Request a call back";

    var heading = content.CallbackHeading?.ToHtmlString();

    var copy = !string.IsNullOrWhiteSpace(content.CallbackCopy)
        ? content.CallbackCopy
        : "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas consectetur, ligula semper sagittis lobortis, eros metus efficitur purus.";

    var submitLabel = !string.IsNullOrWhiteSpace(content.AllbackSubmitLabel)
        ? content.AllbackSubmitLabel
        : "Submit";

    var backgroundImage = content.CallbackBackgroundImage;
    var backgroundImageUrl = backgroundImage?.GetCropUrl(width: 1920) ?? backgroundImage?.Url();
    var sectionInlineStyles = backgroundImageUrl != null
        ? $"background-image: url('{backgroundImageUrl}'); background-size: cover; background-position: center;"
        : null;

    const string formScope = "callback-request";
    var formModel = ViewData["CallbackFormModel"] as CallbackFormViewModel;
    if (formModel == null || !string.Equals(formModel.FormId, formScope, System.StringComparison.OrdinalIgnoreCase))
    {
        formModel = new CallbackFormViewModel { FormId = formScope };
    }
    else
    {
        formModel.FormId = formScope;
    }

    var serviceOptions = new List<string> { "Business", "Financial Consulting", "Tax Planning" };

    formModel.Options = serviceOptions;

    if (string.IsNullOrWhiteSpace(formModel.SelectedOption) && formModel.Options.Any())
    {
        formModel.SelectedOption = formModel.Options.First();
    }

}

<section class="relative overflow-visible pt-24 md:pt-28 pb-40 px-6 md:px-10 bg-neutral" @(sectionInlineStyles != null ? Html.Raw($"style=\"{sectionInlineStyles}\"") : null)>
    @if (!string.IsNullOrWhiteSpace(backgroundImageUrl))
    {
        <img src="@backgroundImageUrl"
             alt=""
             class="absolute left-0 right-0 top-[-80px] w-full bg-neutral -z-20"
             style="height: calc(100% - 170px); object-fit: cover;" />
    }

    <div class="absolute inset-0 bg-neutral/85 backdrop-blur-[2px] -z-10"></div>

    <div class="relative z-20 max-w-5xl mx-auto flex justify-center" style="transform: translateY(210px); margin-bottom: -55px;">
        <div class="w-full bg-neutral rounded-[24px] shadow-[0_50px_100px_rgba(31,41,55,0.12)] px-6 sm:px-12 lg:px-16 py-12 md:py-16 flex flex-col gap-12">
            <div class="text-center flex flex-col items-center gap-6">
                <div class="flex flex-col gap-4">
                    @if (!string.IsNullOrWhiteSpace(heading))
                    {
                        <div class="text-3xl md:text-[2.75rem] font-bold leading-tight text-[#4f5955]">
                            @Html.Raw(heading)
                        </div>
                    }
                    else
                    {
                        <h2 class="text-3xl md:text-[2.75rem] font-bold leading-tight text-[#4f5955]">
                            Let us know about your next project
                        </h2>
                    }
                </div>

                <p class="text-base leading-7 text-[#6b716e] max-w-2xl">@copy</p>
            </div>

            <div>
                @{
                    var formError = TempData.Peek("FormError") as string;
                    var formSuccess = TempData.Peek("FormSuccess") as string;
                }

                @if (!string.IsNullOrWhiteSpace(formError))
                {
                    <div class="mb-4 rounded-[18px] border border-red-200 bg-red-50 px-6 py-3 text-sm text-red-700 shadow-sm">
                        <strong class="text-red-800">Error:</strong>
                        <span class="block">@formError</span>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(formSuccess))
                {
                    <div class="mb-4 rounded-[18px] border border-green-200 bg-green-50 px-6 py-3 text-sm text-green-700 shadow-sm">
                        <strong class="text-green-800">@formSuccess</strong>
                    </div>
                }

                @using (Html.BeginUmbracoForm<FormController>("HandleCallbackForm", new { }, new { id = "callbackRequestForm" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="FormId" value="@formModel.FormId" />

                    <div asp-validation-summary="ModelOnly" class="mb-3 text-sm text-red-600"></div>

                    <div class="flex flex-col gap-6 md:flex-row md:flex-nowrap md:items-start md:gap-10">
                        <div class="w-full md:w-1/2 flex flex-col gap-6">
                            <div class="flex flex-col">
                                <label for="callback-name" class="sr-only">Name</label>
                                @Html.TextBox("Name", formModel.Name, new
                                {
                                    @class = "w-full rounded-xl border border-[#e1e5e4] px-5 py-4 italic text-[0.95rem] text-[#3e443f] placeholder:text-[#9ea4a1] focus:outline-none focus:border-[#4f5955] focus:ring-4 focus:ring-[#4f5955]/15",
                                    id = "callback-name",
                                    placeholder = "Name"
                                })
                                @Html.ValidationMessage("Name", "", new { @class = "text-sm text-red-600 mt-1" })
                            </div>

                            <div class="flex flex-col">
                                <label for="callback-email" class="sr-only">Email address</label>
                                @Html.TextBox("Email", formModel.Email, new
                                {
                                    @class = "w-full rounded-xl border border-[#e1e5e4] px-5 py-4 italic text-[0.95rem] text-[#3e443f] placeholder:text-[#9ea4a1] focus:outline-none focus:border-[#4f5955] focus:ring-4 focus:ring-[#4f5955]/15",
                                    id = "callback-email",
                                    placeholder = "Email address",
                                    type = "email"
                                })
                                @Html.ValidationMessage("Email", "", new { @class = "text-sm text-red-600 mt-1" })
                            </div>
                        </div>

                        <div class="w-full md:w-1/2 flex flex-col gap-6">
                            <div class="flex flex-col">
                                <label for="callback-phone" class="sr-only">Phone</label>
                                @Html.TextBox("Phone", formModel.Phone, new
                                {
                                    @class = "w-full rounded-xl border border-[#e1e5e4] px-5 py-4 italic text-[0.95rem] text-[#3e443f] placeholder:text-[#9ea4a1] focus:outline-none focus:border-[#4f5955] focus:ring-4 focus:ring-[#4f5955]/15",
                                    id = "callback-phone",
                                    placeholder = "Phone"
                                })
                                @Html.ValidationMessage("Phone", "", new { @class = "text-sm text-red-600 mt-1" })
                            </div>

                            <div class="flex flex-col">
                                <label for="callback-option" class="sr-only">Service interest</label>
                                <div class="relative">
                                    <select id="callback-option"
                                            name="SelectedOption"
                                            class="w-full appearance-none rounded-xl border border-[#e1e5e4] px-5 py-4 pr-12 italic text-[0.95rem] text-[#3e443f] placeholder:text-[#9ea4a1] focus:outline-none focus:border-[#4f5955] focus:ring-4 focus:ring-[#4f5955]/15 cursor-pointer">
                                        @foreach (var option in formModel.Options)
                                        {
                                            var isSelected = string.Equals(formModel.SelectedOption, option, System.StringComparison.OrdinalIgnoreCase);
                                            <option value="@option" selected="@(isSelected ? "selected" : null)">@option</option>
                                        }
                                    </select>
                                    <span class="pointer-events-none absolute inset-y-0 right-4 flex items-center" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24">
                                            <path d="m6 9 6 6 6-6" stroke="#3E443F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                    </span>
                                </div>
                                @Html.ValidationMessage("SelectedOption", "", new { @class = "text-sm text-red-600 mt-1" })
                            </div>
                        </div>
                    </div>

                    <div class="mt-9 flex justify-center">
                        <button type="submit" class="inline-flex min-w-[160px] items-center justify-center rounded-xl bg-[#4f5955] px-10 py-4 text-base font-semibold text-white transition hover:-translate-y-px hover:bg-[#434c49] hover:shadow-[0_18px_40px_rgba(79,89,85,0.25)] focus:outline-none focus-visible:ring-4 focus-visible:ring-[#4f5955]/30 active:translate-y-0 active:shadow-[0_10px_28px_rgba(79,89,85,0.2)]">
                            @submitLabel
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</section>
